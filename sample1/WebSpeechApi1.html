<!DOCTYPE html>
<!-- 
    Web Speech API 音声認識デモの動作説明:
    1. 「音声認識を開始」ボタンをクリックすると音声認識が開始されます
    2. ユーザーの音声をリアルタイムで認識し、中間結果を表示します
    3. 無音状態が3秒間続くと自動的に認識を停止し、最終結果を表示します
    4. 「音声認識を停止」ボタンで手動で停止することも可能です
    5. 認識結果は画面中央の枠内に表示されます
    6. エラーが発生した場合はエラーメッセージが表示されます
    
    動作要件:
    - Web Speech API に対応したブラウザが必要です（Chrome推奨）
    - マイクの使用許可が必要です
    - 日本語認識のため言語設定は 'ja-JP' に固定されています
    -->
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Speech API 音声認識デモ</title>
</head>

<body>
    <h1>音声認識デモ</h1>
    <button id="startButton">音声認識を開始</button>
    <button id="stopButton" disabled>音声認識を停止</button>
    <div id="output" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;"></div>

    <script>
        // DOM要素の取得
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const outputDiv = document.getElementById('output');

        // 音声認識オブジェクトの初期化
        // SpeechRecognition APIはブラウザごとにプレフィックスが異なるため、互換性を考慮
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        
        // 認識言語を日本語に設定
        recognition.lang = 'ja-JP';
        
        // 中間結果を取得する設定（trueにすると話している途中の結果も取得可能）
        recognition.interimResults = true;
        
        // 継続的な認識を有効化（falseにすると1回の認識で終了する）
        recognition.continuous = true;

        // 無音検出用のタイマー変数
        let silenceTimer = null;

        // 音声認識開始ボタンのイベントリスナー
        startButton.addEventListener('click', () => {
            // 音声認識を開始
            recognition.start();
            
            // ボタンの状態を更新（開始ボタンを無効化、停止ボタンを有効化）
            startButton.disabled = true;
            stopButton.disabled = false;
            
            // 認識開始メッセージを表示
            outputDiv.textContent = '認識中...';
        });

        // 音声認識結果取得時のイベントリスナー
        recognition.addEventListener('result', (event) => {
            // 無音検出タイマーをリセット（新しい音声入力があったため）
            clearTimeout(silenceTimer);

            // 認識結果をテキストに変換
            // event.resultsは配列形式で提供されるため、Array.fromで変換
            // 各結果からtranscript（認識されたテキスト）を抽出し結合
            const transcript = Array.from(event.results)
                .map(result => result[0]) // 最初の認識結果を取得
                .map(result => result.transcript) // 認識テキストを抽出
                .join(''); // 複数の結果がある場合に結合

            // 無音検出用タイマーを設定（3秒間無音状態が続いた場合の処理）
            silenceTimer = setTimeout(() => {
                // 最終的な認識結果を表示
                outputDiv.textContent = transcript;
                
                // 音声認識を停止
                recognition.stop();
                
                // ボタンの状態をリセット
                startButton.disabled = false;
                stopButton.disabled = true;
            }, 3000); // 3秒間無音が続いたら停止
        });

        // 音声認識エラー時のイベントリスナー
        recognition.addEventListener('error', (event) => {
            // エラーメッセージを表示
            outputDiv.textContent = 'エラーが発生しました: ' + event.error;
            
            // ボタンの状態をリセット
            startButton.disabled = false;
            stopButton.disabled = true;
        });

        // 音声認識終了時のイベントリスナー
        recognition.addEventListener('end', () => {
            // ボタンの状態をリセット（手動停止または自動停止後の処理）
            startButton.disabled = false;
            stopButton.disabled = true;
        });
    </script>
</body>

</html>